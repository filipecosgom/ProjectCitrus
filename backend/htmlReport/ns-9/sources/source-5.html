


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > CourseRepository</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">pt.uc.dei.repositories</a>
</div>

<h1>Coverage Summary for Class: CourseRepository (pt.uc.dei.repositories)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">CourseRepository</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    54.5%
  </span>
  <span class="absValue">
    (6/11)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/82)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    10.7%
  </span>
  <span class="absValue">
    (15/140)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package pt.uc.dei.repositories;
&nbsp;
&nbsp;import jakarta.ejb.Stateless;
&nbsp;import jakarta.persistence.TypedQuery;
&nbsp;import jakarta.persistence.criteria.*;
&nbsp;import org.apache.logging.log4j.LogManager;
&nbsp;import org.apache.logging.log4j.Logger;
&nbsp;import pt.uc.dei.entities.CourseEntity;
&nbsp;import pt.uc.dei.entities.UserEntity;
&nbsp;import pt.uc.dei.enums.CourseArea;
&nbsp;import pt.uc.dei.enums.CourseParameter;
&nbsp;import pt.uc.dei.enums.Language;
&nbsp;import pt.uc.dei.enums.OrderBy;
&nbsp;import pt.uc.dei.utils.SearchUtils;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;
&nbsp;/**
&nbsp; * Repository class for managing {@link CourseEntity} persistence operations.
&nbsp; * &lt;p&gt;
&nbsp; * Provides data access methods specific to course entities, extending the basic
&nbsp; * CRUD operations from {@link AbstractRepository}. This class handles all
&nbsp; * database interactions related to course management.
&nbsp; *
&nbsp; * @Stateless Marks this class as a stateless EJB, making it eligible for
&nbsp; * dependency injection and transaction management by the EJB container.
&nbsp; */
&nbsp;@Stateless
&nbsp;public class CourseRepository extends AbstractRepository&lt;CourseEntity&gt; {
&nbsp;
<b class="fc">&nbsp;    private static final Logger LOGGER = LogManager.getLogger(CourseRepository.class);</b>
&nbsp;    private static final long serialVersionUID = 1L;
&nbsp;
&nbsp;    public CourseRepository() {
<b class="fc">&nbsp;        super(CourseEntity.class);</b>
&nbsp;    }
&nbsp;
&nbsp;    public List&lt;CourseEntity&gt; getAllCourses() {
<b class="fc">&nbsp;        TypedQuery&lt;CourseEntity&gt; query = em.createQuery(</b>
&nbsp;                &quot;SELECT c FROM CourseEntity c ORDER BY c.creationDate DESC&quot;,
&nbsp;                CourseEntity.class
&nbsp;        );
<b class="fc">&nbsp;        return query.getResultList();</b>
&nbsp;    }
&nbsp;
&nbsp;    public long getTotalCourses() {
<b class="fc">&nbsp;        CriteriaBuilder cb = em.getCriteriaBuilder();</b>
<b class="fc">&nbsp;        CriteriaQuery&lt;Long&gt; query = cb.createQuery(Long.class);</b>
<b class="fc">&nbsp;        Root&lt;CourseEntity&gt; root = query.from(CourseEntity.class);</b>
<b class="fc">&nbsp;        query.select(cb.count(root));</b>
<b class="fc">&nbsp;        return em.createQuery(query).getSingleResult();</b>
&nbsp;    }
&nbsp;
&nbsp;    public List&lt;CourseEntity&gt; findCoursesByArea(CourseArea area) {
&nbsp;        try {
<b class="fc">&nbsp;            TypedQuery&lt;CourseEntity&gt; query = em.createQuery(</b>
&nbsp;                &quot;SELECT c FROM CourseEntity c WHERE c.area = :area ORDER BY c.creationDate DESC&quot;,
&nbsp;                CourseEntity.class
&nbsp;            );
<b class="fc">&nbsp;            query.setParameter(&quot;area&quot;, area);</b>
<b class="fc">&nbsp;            return query.getResultList();</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            LOGGER.error(&quot;Error finding courses by area: {}&quot;, area, e);</b>
<b class="nc">&nbsp;            return new ArrayList&lt;&gt;();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public List&lt;CourseEntity&gt; findCoursesByAdmin(Long adminId) {
&nbsp;        try {
<b class="fc">&nbsp;            TypedQuery&lt;CourseEntity&gt; query = em.createQuery(</b>
&nbsp;                &quot;SELECT c FROM CourseEntity c WHERE c.admin.id = :adminId ORDER BY c.creationDate DESC&quot;,
&nbsp;                CourseEntity.class
&nbsp;            );
<b class="fc">&nbsp;            query.setParameter(&quot;adminId&quot;, adminId);</b>
<b class="fc">&nbsp;            return query.getResultList();</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            LOGGER.error(&quot;Error finding courses by admin ID: {}&quot;, adminId, e);</b>
<b class="nc">&nbsp;            return new ArrayList&lt;&gt;();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public List&lt;CourseEntity&gt; findCoursesWithFilters(
&nbsp;            Long id, String title, Integer duration, String description,
&nbsp;            CourseArea area, Language language, String adminName, Boolean courseIsActive,
&nbsp;            CourseParameter parameter, OrderBy orderBy,
&nbsp;            Integer offset, Integer limit, Long excludeCompletedByUserId, List&lt;Long&gt; excludeCourseIds) {
&nbsp;            // Exclude specific course IDs
&nbsp;            
&nbsp;        try {
<b class="nc">&nbsp;            CriteriaBuilder cb = em.getCriteriaBuilder();</b>
<b class="nc">&nbsp;            CriteriaQuery&lt;CourseEntity&gt; cq = cb.createQuery(CourseEntity.class);</b>
<b class="nc">&nbsp;            Root&lt;CourseEntity&gt; course = cq.from(CourseEntity.class);</b>
<b class="nc">&nbsp;            Join&lt;CourseEntity, UserEntity&gt; adminJoin = course.join(&quot;admin&quot;, JoinType.LEFT);</b>
<b class="nc">&nbsp;            List&lt;Predicate&gt; predicates = new ArrayList&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;            if (id != null) {</b>
<b class="nc">&nbsp;                predicates.add(cb.equal(course.get(&quot;id&quot;), id));</b>
&nbsp;            }
&nbsp;            // Exclude specific course IDs
<b class="nc">&nbsp;            if (excludeCourseIds != null &amp;&amp; !excludeCourseIds.isEmpty()) {</b>
<b class="nc">&nbsp;                predicates.add(cb.not(course.get(&quot;id&quot;).in(excludeCourseIds)));</b>
&nbsp;            }
<b class="nc">&nbsp;            if (SearchUtils.isNotBlank(title)) {</b>
<b class="nc">&nbsp;                if (SearchUtils.isQuoted(title)) {</b>
<b class="nc">&nbsp;                    String exact = SearchUtils.stripQuotes(title);</b>
<b class="nc">&nbsp;                    predicates.add(cb.like(course.get(&quot;title&quot;), &quot;%&quot; + exact + &quot;%&quot;));</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    String normalized = SearchUtils.normalizeString(title.toLowerCase());</b>
<b class="nc">&nbsp;                    Expression&lt;String&gt; unaccentedTitle = cb.function(&quot;unaccent&quot;, String.class, cb.lower(course.get(&quot;title&quot;)));</b>
<b class="nc">&nbsp;                    predicates.add(cb.like(unaccentedTitle, &quot;%&quot; + normalized + &quot;%&quot;));</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if (duration != null) {</b>
<b class="nc">&nbsp;                predicates.add(cb.equal(course.get(&quot;duration&quot;), duration));</b>
&nbsp;            }
<b class="nc">&nbsp;            if (SearchUtils.isNotBlank(description)) {</b>
<b class="nc">&nbsp;                if (SearchUtils.isQuoted(description)) {</b>
<b class="nc">&nbsp;                    String exact = SearchUtils.stripQuotes(description);</b>
<b class="nc">&nbsp;                    predicates.add(cb.like(course.get(&quot;description&quot;), &quot;%&quot; + exact + &quot;%&quot;));</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    String normalized = SearchUtils.normalizeString(description.toLowerCase());</b>
<b class="nc">&nbsp;                    Expression&lt;String&gt; unaccentedDescription = cb.function(&quot;unaccent&quot;, String.class, cb.lower(course.get(&quot;description&quot;)));</b>
<b class="nc">&nbsp;                    predicates.add(cb.like(unaccentedDescription, &quot;%&quot; + normalized + &quot;%&quot;));</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if (area != null) {</b>
<b class="nc">&nbsp;                predicates.add(cb.equal(course.get(&quot;area&quot;), area));</b>
&nbsp;            }
<b class="nc">&nbsp;            if (language != null) {</b>
<b class="nc">&nbsp;                predicates.add(cb.equal(course.get(&quot;language&quot;), language));</b>
&nbsp;            }
<b class="nc">&nbsp;            if (SearchUtils.isNotBlank(adminName)) {</b>
<b class="nc">&nbsp;                predicates.add(cb.like(adminJoin.get(&quot;name&quot;), &quot;%&quot; + adminName + &quot;%&quot;));</b>
&nbsp;            }
<b class="nc">&nbsp;            if (courseIsActive != null) {</b>
<b class="nc">&nbsp;                predicates.add(cb.equal(course.get(&quot;courseIsActive&quot;), courseIsActive));</b>
&nbsp;            }
&nbsp;
&nbsp;            // Exclude completed courses for excludeCompletedByUserId
<b class="nc">&nbsp;            if (excludeCompletedByUserId != null) {</b>
<b class="nc">&nbsp;                Subquery&lt;Long&gt; subquery = cq.subquery(Long.class);</b>
<b class="nc">&nbsp;                Root&lt;pt.uc.dei.entities.FinishedCourseEntity&gt; finished = subquery.from(pt.uc.dei.entities.FinishedCourseEntity.class);</b>
<b class="nc">&nbsp;                subquery.select(finished.get(&quot;course&quot;).get(&quot;id&quot;))</b>
<b class="nc">&nbsp;                        .where(</b>
<b class="nc">&nbsp;                                cb.equal(finished.get(&quot;user&quot;).get(&quot;id&quot;), excludeCompletedByUserId),</b>
<b class="nc">&nbsp;                                cb.equal(finished.get(&quot;course&quot;).get(&quot;id&quot;), course.get(&quot;id&quot;))</b>
&nbsp;                        );
<b class="nc">&nbsp;                predicates.add(cb.not(cb.exists(subquery)));</b>
&nbsp;            }
<b class="nc">&nbsp;            if (excludeCourseIds != null &amp;&amp; !excludeCourseIds.isEmpty()) {</b>
<b class="nc">&nbsp;                predicates.add(cb.not(course.get(&quot;id&quot;).in(excludeCourseIds)));</b>
&nbsp;            }
<b class="nc">&nbsp;            cq.where(predicates.toArray(new Predicate[0]));</b>
&nbsp;
&nbsp;            // Sorting
<b class="nc">&nbsp;            if (parameter != null) {</b>
&nbsp;                Path&lt;?&gt; sortingField;
<b class="nc">&nbsp;                if (&quot;admin.name&quot;.equals(parameter.getFieldName())) {</b>
<b class="nc">&nbsp;                    sortingField = adminJoin.get(&quot;name&quot;);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    sortingField = course.get(parameter.getFieldName());</b>
&nbsp;                }
<b class="nc">&nbsp;                cq.orderBy(orderBy == OrderBy.DESCENDING ? cb.desc(sortingField) : cb.asc(sortingField));</b>
&nbsp;            } else {
<b class="nc">&nbsp;                cq.orderBy(cb.desc(course.get(&quot;creationDate&quot;)));</b>
&nbsp;            }
<b class="nc">&nbsp;            TypedQuery&lt;CourseEntity&gt; typedQuery = em.createQuery(cq);</b>
<b class="nc">&nbsp;            if(offset != null &amp;&amp; offset &gt;= 0) {</b>
<b class="nc">&nbsp;                typedQuery.setFirstResult(offset);</b>
&nbsp;            }
<b class="nc">&nbsp;            if(limit != null &amp;&amp; limit &gt;= 0) {</b>
<b class="nc">&nbsp;                typedQuery.setMaxResults(limit);</b>
&nbsp;            }
<b class="nc">&nbsp;            return typedQuery.getResultList();</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            LOGGER.error(&quot;Error finding courses with filters&quot;, e);</b>
<b class="nc">&nbsp;            return new ArrayList&lt;&gt;();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public long countCoursesWithFilters(Long id, String title, Integer duration, String description,
&nbsp;                                        CourseArea area, Language language, String adminName, Boolean courseIsActive, Long excludeCompletedByUserId, List&lt;Long&gt; excludeCourseIds) {
&nbsp;            // Exclude specific course IDs
&nbsp;        try {
<b class="nc">&nbsp;            CriteriaBuilder cb = em.getCriteriaBuilder();</b>
<b class="nc">&nbsp;            CriteriaQuery&lt;Long&gt; cq = cb.createQuery(Long.class);</b>
<b class="nc">&nbsp;            Root&lt;CourseEntity&gt; course = cq.from(CourseEntity.class);</b>
<b class="nc">&nbsp;            Join&lt;CourseEntity, UserEntity&gt; adminJoin = course.join(&quot;admin&quot;, JoinType.LEFT);</b>
<b class="nc">&nbsp;            List&lt;Predicate&gt; predicates = new ArrayList&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;            if (id != null) {</b>
<b class="nc">&nbsp;                predicates.add(cb.equal(course.get(&quot;id&quot;), id));</b>
&nbsp;            }
&nbsp;            // Exclude specific course IDs
<b class="nc">&nbsp;            if (excludeCourseIds != null &amp;&amp; !excludeCourseIds.isEmpty()) {</b>
<b class="nc">&nbsp;                predicates.add(cb.not(course.get(&quot;id&quot;).in(excludeCourseIds)));</b>
&nbsp;            }
<b class="nc">&nbsp;            if (SearchUtils.isNotBlank(title)) {</b>
<b class="nc">&nbsp;                if (SearchUtils.isQuoted(title)) {</b>
<b class="nc">&nbsp;                    String exact = SearchUtils.stripQuotes(title);</b>
<b class="nc">&nbsp;                    predicates.add(cb.like(course.get(&quot;title&quot;), &quot;%&quot; + exact + &quot;%&quot;));</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    String normalized = SearchUtils.normalizeString(title.toLowerCase());</b>
<b class="nc">&nbsp;                    Expression&lt;String&gt; unaccentedTitle = cb.function(&quot;unaccent&quot;, String.class, cb.lower(course.get(&quot;title&quot;)));</b>
<b class="nc">&nbsp;                    predicates.add(cb.like(unaccentedTitle, &quot;%&quot; + normalized + &quot;%&quot;));</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if (duration != null) {</b>
<b class="nc">&nbsp;                predicates.add(cb.equal(course.get(&quot;duration&quot;), duration));</b>
&nbsp;            }
<b class="nc">&nbsp;            if (SearchUtils.isNotBlank(description)) {</b>
<b class="nc">&nbsp;                if (SearchUtils.isQuoted(description)) {</b>
<b class="nc">&nbsp;                    String exact = SearchUtils.stripQuotes(description);</b>
<b class="nc">&nbsp;                    predicates.add(cb.like(course.get(&quot;description&quot;), &quot;%&quot; + exact + &quot;%&quot;));</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    String normalized = SearchUtils.normalizeString(description.toLowerCase());</b>
<b class="nc">&nbsp;                    Expression&lt;String&gt; unaccentedDescription = cb.function(&quot;unaccent&quot;, String.class, cb.lower(course.get(&quot;description&quot;)));</b>
<b class="nc">&nbsp;                    predicates.add(cb.like(unaccentedDescription, &quot;%&quot; + normalized + &quot;%&quot;));</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if (area != null) {</b>
<b class="nc">&nbsp;                predicates.add(cb.equal(course.get(&quot;area&quot;), area));</b>
&nbsp;            }
<b class="nc">&nbsp;            if (language != null) {</b>
<b class="nc">&nbsp;                predicates.add(cb.equal(course.get(&quot;language&quot;), language));</b>
&nbsp;            }
<b class="nc">&nbsp;            if (SearchUtils.isNotBlank(adminName)) {</b>
<b class="nc">&nbsp;                predicates.add(cb.like(adminJoin.get(&quot;name&quot;), &quot;%&quot; + adminName + &quot;%&quot;));</b>
&nbsp;            }
<b class="nc">&nbsp;            if (Boolean.TRUE.equals(courseIsActive)) {</b>
<b class="nc">&nbsp;                predicates.add(cb.isTrue(course.get(&quot;courseIsActive&quot;)));</b>
&nbsp;            }
&nbsp;            // Exclude completed courses for excludeCompletedByUserId
<b class="nc">&nbsp;            if (excludeCompletedByUserId != null) {</b>
<b class="nc">&nbsp;                Subquery&lt;Long&gt; subquery = cq.subquery(Long.class);</b>
<b class="nc">&nbsp;                Root&lt;pt.uc.dei.entities.FinishedCourseEntity&gt; finished = subquery.from(pt.uc.dei.entities.FinishedCourseEntity.class);</b>
<b class="nc">&nbsp;                subquery.select(finished.get(&quot;course&quot;).get(&quot;id&quot;))</b>
<b class="nc">&nbsp;                        .where(</b>
<b class="nc">&nbsp;                                cb.equal(finished.get(&quot;user&quot;).get(&quot;id&quot;), excludeCompletedByUserId),</b>
<b class="nc">&nbsp;                                cb.equal(finished.get(&quot;course&quot;).get(&quot;id&quot;), course.get(&quot;id&quot;))</b>
&nbsp;                        );
<b class="nc">&nbsp;                predicates.add(cb.not(cb.exists(subquery)));</b>
&nbsp;            }
<b class="nc">&nbsp;            if (excludeCourseIds != null &amp;&amp; !excludeCourseIds.isEmpty()) {</b>
<b class="nc">&nbsp;                predicates.add(cb.not(course.get(&quot;id&quot;).in(excludeCourseIds)));</b>
&nbsp;            }
<b class="nc">&nbsp;            cq.where(predicates.toArray(new Predicate[0]));</b>
<b class="nc">&nbsp;            cq.select(cb.count(course));</b>
<b class="nc">&nbsp;            return em.createQuery(cq).getSingleResult();</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            LOGGER.error(&quot;Error counting courses with filters&quot;, e);</b>
<b class="nc">&nbsp;            return 0L;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    // Update: find by id (now Long id is PK)
&nbsp;    public CourseEntity findCourseById(Long id) {
&nbsp;        try {
<b class="nc">&nbsp;            return em.find(CourseEntity.class, id);</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            LOGGER.error(&quot;Error finding course by id: {}&quot;, id, e);</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    // Checks if a course with the given title already exists (case-insensitive)
&nbsp;    public boolean existsByTitle(String title) {
&nbsp;        try {
<b class="nc">&nbsp;            TypedQuery&lt;Long&gt; query = em.createQuery(</b>
&nbsp;                &quot;SELECT COUNT(c) FROM CourseEntity c WHERE LOWER(c.title) = LOWER(:title)&quot;,
&nbsp;                Long.class
&nbsp;            );
<b class="nc">&nbsp;            query.setParameter(&quot;title&quot;, title);</b>
<b class="nc">&nbsp;            Long count = query.getSingleResult();</b>
<b class="nc">&nbsp;            return count != null &amp;&amp; count &gt; 0;</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            LOGGER.error(&quot;Error checking if course exists by title: {}&quot;, title, e);</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    // Checks if a course with the given link already exists (case-insensitive)
&nbsp;    public boolean existsByLink(String link) {
&nbsp;        try {
<b class="nc">&nbsp;            TypedQuery&lt;Long&gt; query = em.createQuery(</b>
&nbsp;                &quot;SELECT COUNT(c) FROM CourseEntity c WHERE LOWER(c.link) = LOWER(:link)&quot;,
&nbsp;                Long.class
&nbsp;            );
<b class="nc">&nbsp;            query.setParameter(&quot;link&quot;, link);</b>
<b class="nc">&nbsp;            Long count = query.getSingleResult();</b>
<b class="nc">&nbsp;            return count != null &amp;&amp; count &gt; 0;</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            LOGGER.error(&quot;Error checking if course exists by link: {}&quot;, link, e);</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-07-15 20:29</div>
</div>
</body>
</html>
