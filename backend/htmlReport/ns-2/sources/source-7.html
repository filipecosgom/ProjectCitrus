


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > MessageController</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">pt.uc.dei.controllers</a>
</div>

<h1>Coverage Summary for Class: MessageController (pt.uc.dei.controllers)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">MessageController</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (7/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    88.2%
  </span>
  <span class="absValue">
    (30/34)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    89.9%
  </span>
  <span class="absValue">
    (107/119)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package pt.uc.dei.controllers;
&nbsp;
&nbsp;import jakarta.inject.Inject;
&nbsp;import jakarta.json.JsonObject;
&nbsp;import jakarta.servlet.http.HttpServletRequest;
&nbsp;import jakarta.validation.Valid;
&nbsp;import jakarta.ws.rs.*;
&nbsp;import jakarta.ws.rs.container.ContainerRequestContext;
&nbsp;import jakarta.ws.rs.core.Context;
&nbsp;import jakarta.ws.rs.core.MediaType;
&nbsp;import jakarta.ws.rs.core.Response;
&nbsp;import org.apache.logging.log4j.LogManager;
&nbsp;import org.apache.logging.log4j.Logger;
&nbsp;import pt.uc.dei.annotations.AnotherOnly;
&nbsp;import pt.uc.dei.dtos.MessageSendDTO;
&nbsp;import pt.uc.dei.dtos.UserResponseDTO;
&nbsp;import pt.uc.dei.services.MessageService;
&nbsp;import pt.uc.dei.services.NotificationService;
&nbsp;import pt.uc.dei.services.UserService;
&nbsp;import pt.uc.dei.utils.ApiResponse;
&nbsp;import pt.uc.dei.utils.JWTUtil;
&nbsp;import pt.uc.dei.dtos.MessageDTO;
&nbsp;import pt.uc.dei.dtos.UserDTO;
&nbsp;import pt.uc.dei.dtos.ConversationPreviewDTO;
&nbsp;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;
&nbsp;@Path(&quot;/messages&quot;)
<b class="fc">&nbsp;public class MessageController {</b>
<b class="fc">&nbsp;    private static final Logger LOGGER = LogManager.getLogger(MessageController.class);</b>
&nbsp;
&nbsp;    @Inject
&nbsp;    UserService userService;
&nbsp;
&nbsp;    @Inject
&nbsp;    MessageService messageService;
&nbsp;
&nbsp;    @Inject
&nbsp;    NotificationService notificationService;
&nbsp;
&nbsp;    @GET
&nbsp;    @Produces(MediaType.APPLICATION_JSON)
&nbsp;    @Path(&quot;{id}&quot;)
&nbsp;    public Response getChat(@PathParam(&quot;id&quot;) Long otherUserId, @CookieParam(&quot;jwt&quot;) String jwtToken) {
&nbsp;        try {
&nbsp;            // Validate JWT cookie exists
<b class="pc">&nbsp;            if (jwtToken == null || jwtToken.isEmpty()) {</b>
<b class="fc">&nbsp;                LOGGER.warn(&quot;Unauthorized chat request: missing JWT cookie&quot;);</b>
<b class="fc">&nbsp;                return Response.status(Response.Status.UNAUTHORIZED)</b>
<b class="fc">&nbsp;                        .entity(new ApiResponse(false, &quot;Unauthorized&quot;, &quot;errorUnauthorized&quot;, null))</b>
<b class="fc">&nbsp;                        .build();</b>
&nbsp;            }
&nbsp;
&nbsp;            // Extract user ID from JWT
<b class="fc">&nbsp;            Long userId = JWTUtil.getUserIdFromToken(jwtToken);</b>
&nbsp;
<b class="fc">&nbsp;            if (userId == null) {</b>
<b class="fc">&nbsp;                LOGGER.warn(&quot;Invalid JWT token in chat request&quot;);</b>
<b class="fc">&nbsp;                return Response.status(Response.Status.UNAUTHORIZED)</b>
<b class="fc">&nbsp;                        .entity(new ApiResponse(false, &quot;Unauthorized&quot;, &quot;errorUnauthorized&quot;, null))</b>
<b class="fc">&nbsp;                        .build();</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            LOGGER.info(&quot;Request to get chat with userId: {} and otherUserId: {}&quot;, userId, otherUserId);</b>
<b class="fc">&nbsp;        List&lt;MessageDTO&gt; conversation = messageService.getMessagesBetween(userId, otherUserId);</b>
<b class="pc">&nbsp;        if (conversation == null || conversation.isEmpty()) {</b>
<b class="fc">&nbsp;            LOGGER.info(&quot;No conversation found between userId {} and otherUserId {}&quot;, userId, otherUserId);</b>
<b class="fc">&nbsp;            return Response.status(Response.Status.NOT_FOUND)</b>
<b class="fc">&nbsp;                    .entity(new ApiResponse(false, &quot;No conversation found&quot;, &quot;errorNoConversation&quot;, null))</b>
<b class="fc">&nbsp;                    .build();</b>
&nbsp;        }
<b class="fc">&nbsp;            LOGGER.info(&quot;Conversation retrieved between userId {} and otherUserId {}&quot;, userId, otherUserId);</b>
<b class="fc">&nbsp;            return Response.ok(new ApiResponse(true, &quot;Conversation retrieved&quot;, &quot;successConversationRetrieved&quot;, conversation))</b>
<b class="fc">&nbsp;                    .build();</b>
&nbsp;
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            LOGGER.error(&quot;Error retrieving conversation&quot;, e);</b>
<b class="nc">&nbsp;            return Response.status(Response.Status.INTERNAL_SERVER_ERROR)</b>
<b class="nc">&nbsp;                    .entity(new ApiResponse(false, &quot;Server error&quot;, &quot;errorServer&quot;, null))</b>
<b class="nc">&nbsp;                    .build();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @GET
&nbsp;    @Produces(MediaType.APPLICATION_JSON)
&nbsp;    @Path(&quot;all&quot;)
&nbsp;    public Response getAllUsersWhoChat(@CookieParam(&quot;jwt&quot;) String jwtToken) {
<b class="fc">&nbsp;        LOGGER.info(&quot;Request to get all users who chat&quot;);</b>
&nbsp;
&nbsp;        // Validate JWT
<b class="fc">&nbsp;        Long userId = JWTUtil.getUserIdFromToken(jwtToken);</b>
<b class="fc">&nbsp;        if (userId == null) {</b>
<b class="fc">&nbsp;            LOGGER.warn(&quot;Missing or invalid JWT in getAllUsersWhoChat&quot;);</b>
<b class="fc">&nbsp;            return Response.status(Response.Status.UNAUTHORIZED)</b>
<b class="fc">&nbsp;                    .entity(new ApiResponse(false, &quot;Missing token&quot;, &quot;errorMissingToken&quot;, null))</b>
<b class="fc">&nbsp;                    .build();</b>
&nbsp;        }
&nbsp;
&nbsp;        try {
<b class="fc">&nbsp;            List&lt;UserResponseDTO&gt; userList = messageService.getAllChats(userId);</b>
<b class="pc">&nbsp;            if (userList == null || userList.isEmpty()) {</b>
<b class="fc">&nbsp;                LOGGER.info(&quot;No conversations found for userId {}&quot;, userId);</b>
<b class="fc">&nbsp;                return Response.status(Response.Status.NOT_FOUND)</b>
<b class="fc">&nbsp;                        .entity(new ApiResponse(false, &quot;No conversations found&quot;, &quot;errorNoConversations&quot;, null))</b>
<b class="fc">&nbsp;                        .build();</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            LOGGER.info(&quot;All conversations retrieved for userId {}&quot;, userId);</b>
<b class="fc">&nbsp;            return Response.ok(new ApiResponse(true, &quot;All conversations retrieved&quot;, &quot;successConversationsRetrieved&quot;, userList))</b>
<b class="fc">&nbsp;                    .build();</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            LOGGER.error(&quot;Error in getAllUsersWhoChat&quot;, e);</b>
<b class="nc">&nbsp;            return Response.status(Response.Status.INTERNAL_SERVER_ERROR)</b>
<b class="nc">&nbsp;                    .entity(new ApiResponse(false, &quot;Internal server error&quot;, &quot;errorInternal&quot;, null))</b>
<b class="nc">&nbsp;                    .build();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @POST
&nbsp;    @Produces(MediaType.APPLICATION_JSON)
&nbsp;    @Consumes(MediaType.APPLICATION_JSON)
&nbsp;    public Response sendMessage(
&nbsp;            @CookieParam(&quot;jwt&quot;) String jwtToken,
&nbsp;            @Valid MessageSendDTO messageDTO) {
&nbsp;
<b class="fc">&nbsp;        LOGGER.info(&quot;Request to send message: {}&quot;, messageDTO);</b>
&nbsp;
&nbsp;        // Validate JWT
<b class="fc">&nbsp;        Long senderId = JWTUtil.getUserIdFromToken(jwtToken);</b>
<b class="fc">&nbsp;        if (senderId == null) {</b>
<b class="fc">&nbsp;            LOGGER.warn(&quot;Unauthorized sendMessage request: missing or invalid JWT&quot;);</b>
<b class="fc">&nbsp;            return Response.status(Response.Status.UNAUTHORIZED)</b>
<b class="fc">&nbsp;                    .entity(new ApiResponse(false, &quot;Unauthorized&quot;, &quot;errorUnauthorized&quot;, null))</b>
<b class="fc">&nbsp;                    .build();</b>
&nbsp;        }
<b class="fc">&nbsp;        if(senderId == messageDTO.getReceiverId()) {</b>
<b class="fc">&nbsp;            LOGGER.warn(&quot;Sender and receiver cannot be the same user&quot;);</b>
<b class="fc">&nbsp;            return Response.status(Response.Status.BAD_REQUEST)</b>
<b class="fc">&nbsp;                    .entity(new ApiResponse(false, &quot;Sender and receiver cannot be the same user&quot;, &quot;errorSameUser&quot;, null))</b>
<b class="fc">&nbsp;                    .build();</b>
&nbsp;        }
<b class="fc">&nbsp;        MessageDTO newMessage = new MessageDTO();</b>
<b class="fc">&nbsp;        newMessage.setSenderId(senderId);</b>
<b class="fc">&nbsp;        newMessage.setReceiverId(messageDTO.getReceiverId());</b>
<b class="fc">&nbsp;        newMessage.setMessageContent(messageDTO.getContent());</b>
<b class="fc">&nbsp;        newMessage.setSentDate(LocalDateTime.now());</b>
<b class="fc">&nbsp;        newMessage.setMessageIsRead(false);</b>
&nbsp;
&nbsp;        try {
<b class="fc">&nbsp;            MessageDTO savedMessage = messageService.newMessage(newMessage);</b>
<b class="fc">&nbsp;            if (savedMessage == null) {</b>
<b class="fc">&nbsp;                LOGGER.error(&quot;Failed to save message from userId {} to userId {}&quot;, senderId, messageDTO.getReceiverId());</b>
<b class="fc">&nbsp;                return Response.status(Response.Status.INTERNAL_SERVER_ERROR)</b>
<b class="fc">&nbsp;                        .entity(new ApiResponse(false, &quot;Failed to send message&quot;, &quot;errorSendMessage&quot;, null))</b>
<b class="fc">&nbsp;                        .build();</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            LOGGER.info(&quot;Message sent from userId {} to userId {}&quot;, senderId, messageDTO.getReceiverId());</b>
<b class="fc">&nbsp;            return Response.ok(new ApiResponse(true, &quot;Message sent successfully&quot;, &quot;successMessageSent&quot;, savedMessage))</b>
<b class="fc">&nbsp;                    .build();</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            LOGGER.error(&quot;Exception in sendMessage&quot;, e);</b>
<b class="nc">&nbsp;            return Response.status(Response.Status.INTERNAL_SERVER_ERROR)</b>
<b class="nc">&nbsp;                    .entity(new ApiResponse(false, &quot;Internal server error&quot;, &quot;errorInternal&quot;, null))</b>
<b class="nc">&nbsp;                    .build();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @PATCH
&nbsp;    @Produces(MediaType.APPLICATION_JSON)
&nbsp;    @Path(&quot;/{id}&quot;)
&nbsp;    public Response readConversation(
&nbsp;            @CookieParam(&quot;jwt&quot;) String jwtToken,
&nbsp;            @PathParam(&quot;id&quot;) Long senderId) {
&nbsp;
&nbsp;        // Validate JWT
<b class="fc">&nbsp;        Long recipientId = JWTUtil.getUserIdFromToken(jwtToken);</b>
<b class="fc">&nbsp;        if (recipientId == null) {</b>
<b class="fc">&nbsp;            LOGGER.warn(&quot;Unauthorized readConversation request: missing or invalid JWT&quot;);</b>
<b class="fc">&nbsp;            return Response.status(Response.Status.UNAUTHORIZED)</b>
<b class="fc">&nbsp;                    .entity(new ApiResponse(false, &quot;Unauthorized&quot;, &quot;errorUnauthorized&quot;, null))</b>
<b class="fc">&nbsp;                    .build();</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        if (senderId == null) {</b>
<b class="fc">&nbsp;            return Response.status(Response.Status.BAD_REQUEST)</b>
<b class="fc">&nbsp;                    .entity(new ApiResponse(false, &quot;Sender ID cannot be empty&quot;, &quot;errorMissingSenderId&quot;, null))</b>
<b class="fc">&nbsp;                    .build();</b>
&nbsp;        }
&nbsp;
&nbsp;        try {
<b class="fc">&nbsp;            boolean success = messageService.readAllConversation(recipientId, senderId);</b>
<b class="fc">&nbsp;            if (success) {</b>
<b class="fc">&nbsp;                LOGGER.info(&quot;Conversation read by userId {}&quot;, recipientId);</b>
<b class="fc">&nbsp;                return Response.ok(new ApiResponse(true, &quot;Conversation read&quot;, &quot;successConversationRead&quot;, null))</b>
<b class="fc">&nbsp;                        .build();</b>
&nbsp;            } else {
<b class="fc">&nbsp;                return Response.status(Response.Status.NOT_FOUND)</b>
<b class="fc">&nbsp;                        .entity(new ApiResponse(false, &quot;No conversation found&quot;, &quot;errorNoConversation&quot;, null))</b>
<b class="fc">&nbsp;                        .build();</b>
&nbsp;            }
&nbsp;        } catch (Exception e) {
<b class="fc">&nbsp;            LOGGER.error(&quot;Exception in readConversation&quot;, e);</b>
<b class="fc">&nbsp;            return Response.status(Response.Status.INTERNAL_SERVER_ERROR)</b>
<b class="fc">&nbsp;                    .entity(new ApiResponse(false, &quot;Internal server error&quot;, &quot;errorInternal&quot;, null))</b>
<b class="fc">&nbsp;                    .build();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @GET
&nbsp;    @Produces(MediaType.APPLICATION_JSON)
&nbsp;    @Path(&quot;conversations&quot;)
&nbsp;    public Response getConversationPreviews(@CookieParam(&quot;jwt&quot;) String jwtToken) {
<b class="fc">&nbsp;        LOGGER.info(&quot;Request to get conversation previews&quot;);</b>
&nbsp;
&nbsp;        // Validate JWT
<b class="fc">&nbsp;        Long userId = JWTUtil.getUserIdFromToken(jwtToken);</b>
<b class="fc">&nbsp;        if (userId == null) {</b>
<b class="fc">&nbsp;            LOGGER.warn(&quot;Missing or invalid JWT in getConversationPreviews&quot;);</b>
<b class="fc">&nbsp;            return Response.status(Response.Status.UNAUTHORIZED)</b>
<b class="fc">&nbsp;                    .entity(new ApiResponse(false, &quot;Missing token&quot;, &quot;errorMissingToken&quot;, null))</b>
<b class="fc">&nbsp;                    .build();</b>
&nbsp;        }
&nbsp;
&nbsp;        try {
<b class="fc">&nbsp;            List&lt;ConversationPreviewDTO&gt; conversationPreviews = messageService.getConversationPreviews(userId);</b>
&nbsp;            
<b class="pc">&nbsp;            if (conversationPreviews == null || conversationPreviews.isEmpty()) {</b>
<b class="fc">&nbsp;                LOGGER.info(&quot;No conversation previews found for userId {}&quot;, userId);</b>
<b class="fc">&nbsp;                return Response.ok(new ApiResponse(true, &quot;No conversations found&quot;, &quot;successNoConversations&quot;, new ArrayList&lt;&gt;()))</b>
<b class="fc">&nbsp;                        .build();</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            LOGGER.info(&quot;Conversation previews retrieved for userId {}: {} conversations&quot;, userId, conversationPreviews.size());</b>
<b class="fc">&nbsp;            return Response.ok(new ApiResponse(true, &quot;Conversation previews retrieved&quot;, &quot;successConversationPreviewsRetrieved&quot;, conversationPreviews))</b>
<b class="fc">&nbsp;                    .build();</b>
&nbsp;        } catch (Exception e) {
<b class="fc">&nbsp;            LOGGER.error(&quot;Error in getConversationPreviews for userId {}&quot;, userId, e);</b>
<b class="fc">&nbsp;            return Response.status(Response.Status.INTERNAL_SERVER_ERROR)</b>
<b class="fc">&nbsp;                    .entity(new ApiResponse(false, &quot;Internal server error&quot;, &quot;errorInternal&quot;, null))</b>
<b class="fc">&nbsp;                    .build();</b>
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-07-15 20:29</div>
</div>
</body>
</html>
